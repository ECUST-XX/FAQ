## PHP的垃圾回收机制以及大概实现

### 这个问题一般问的都是个思路，面试官试图通过这个问题能够得知你对PHP底层了解深度，除此之外还能更深度地考察你的思维。因为一般上层语言的实现中，垃圾回收机制一般思路都是通用的

#### php垃圾回收机制

* php采用引用计数机制,当变量赋值,传递时并不会直接硬拷贝,而是增加value的引用数,unset,return等释放变量时再减掉引用数,减掉后如果发现refcount变为0则直接释放value

* 但是上述方法并没有解决自身引用的问题,所以php引入了其他机制来进行垃圾回收

* 如果一个变量value的refcount减少到0,那么此value可以被释放掉,不属于垃圾

* 如果一个变量value的refcount减少之后大于0,那么此zval还不能被释放,此zval可能成为一个垃圾,只会出现在array和object类型上

* refcount大于0的疑似变量在加入到一个专门用于处理垃圾的缓冲buffer(双向链表)中后,为了防止重复加入变量的gc信息被标记为紫色,在缓冲区变量个数达到10000后开始垃圾回收

* 垃圾回收时遍历buffer中的所有变量并将其标记为灰色,而且对变量的所有成员进行遍历(深度优先遍历),然后把成员的refcount减1并标记为灰色,如果变量在被遍历完后当前引用减为0则为垃圾并标记为白色,否则不是垃圾并标记为黑色,最后再次遍历buffer将标记为白色的变量从链表删除

> https://github.com/pangudashu/php7-internal/blob/master/5/gc.md

#### golang垃圾回收机制

* Go 语言垃圾收集器的实现非常复杂,是编程语言中最复杂的一个模块,调度器的复杂度与垃圾收集器完全不是一个级别,它的执行速度和利用率很大程度上决定了程序的运行速度,Go 语言为了实现高性能的并发垃圾收集器,使用三色抽象,并发增量回收,混合写屏障,调步算法以及用户程序协助等机制将垃圾收集的暂停时间优化至毫秒级以下

> https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-garbage-collector/

> http://legendtkl.com/2017/04/28/golang-gc/


